# // tag::queries[]



get-user =  select nip,nama,pangkat,gol,password,tp.id_jabatan idJabatan,tp.kode_unor kodeUnor,tu.nama_unor namaUnor, tu.nama_jabatan namaJabatan,tu.level,tp.id_satuan_kerja idSatuanKerja,sk.nama_satuan_kerja namaSatuanKerja, case when tu.parent_id='0' then tu.id end parentUnor,tp.path_foto pathFoto from tbl_pegawai tp left join tbl_unor tu on tu.kode_unor = tp.kode_unor left join tbl_satuan_kerja sk on sk.id_satuan_kerja=tp.id_satuan_kerja where nip=?

get-mail = select array_to_json(array_agg(row_to_json(t))) as data from (select mail_id,mail_naskah,mail_perihal,mail_tgl_surat,(select nama from tbl_pegawai where nip=mail_user)as user_entry, mail_user,mail_no_agenda,mail_tgl_diterima, mail_alamat_pengirim,mail_cc,mail_klasifikasi,(select name from klasifikasi where id=mail_klasifikasi) as klasifikasi,(select nama_jenis_surat from jenis_surat where id=mail_jenis_surat) as jenis_surat,mail_jenis_surat,mail_sifat_surat,mail_jenis_instansi, mail_status,mano_type,mano_staff from mail,mail_notification where mail_id=mano_mail_id and mano_staff =? and mano_type=?  )t 

get-mail-to =select array_to_json(array_agg(row_to_json(t))) as data from (select mato_id,mato_mail_id,mato_pengirim,mato_dari,tf.nama_unor mato_dari_unor,mato_tujuan,td.nama_unor mato_tujuan_unor, mato_status,mato_action,mato_type,(select array_to_json(array_agg(row_to_json(staff))) from(select mano_type,mano_status,mano_staff,tp.nama,tp.pangkat,tp.gol,tp.jabatan,tu.nama_jabatan,tp.status,tp.id_satuan_kerja,(select nama_satuan_kerja from tbl_satuan_kerja sk where sk.id_satuan_kerja=tp.id_satuan_kerja ) as nama_satuan_Kerja,tu.level,mano_unor, tu.nama_unor from mail_notification left join tbl_pegawai tp on tp.nip=mano_staff left join tbl_unor tu on tu.kode_unor=mano_unor where mano_mato_id= mato_id and mano_mail_id=cast(? as integer))staff)as staff from mail_to left join tbl_unor tf on tf.kode_unor=mato_dari left join tbl_unor td on td.kode_unor = mato_tujuan where mato_mail_id=cast(? as integer))t

get-inbox-byuserid = select sm.id,sm.id_asal,sm.id_tujuan,tu.nama_unor unor_tujuan,no_surat,id_klasifikasi,kl.name klasifikasi,id_jenis_surat, js.nama_jenis_surat,no_urut, no_referensi,id_tipe,ts.name tipe_surat,perihal,to_char(tgl_surat, 'DD-MM-YYYY')tgl_surat,to_char(tgl_diterima, 'DD-MM-YYYY')tgl_diterima,sm.id_file file_id,is_disposisi, sm.is_view,sm.created_by,tp.nama dibuat,sm.created_at, id_instansi_tujuan,id_asal_luar,alamat_tujuan from surat_masuk sm left join tbl_unor tu on tu.id= cast (sm.id_tujuan as text) left join klasifikasi kl on kl.id= sm.id_klasifikasi left join jenis_surat js on js.id= sm.id_jenis_surat left join tipe_surat ts on ts.id= cast (sm.id_tipe as integer) left join tbl_pegawai tp on tp.id= sm.created_by where exists (select 1 from notifikasi where id_content=sm.id and notif_nip=?)

get-staff=select nip1 nip,nama,pangkat,gol,jabatan,id_jabatan,status,path_foto from tbl_pegawai where kode_unor=?

get-staff-lev1= select array_to_json(array_agg(row_to_json(t))) as data from ( with recursive unor (id,kode_unor,nama_jabatan,level,parent_id) as( select tp.id,tp.kode_unor,tp.nama_jabatan,tp.level,tp.parent_id from tbl_unor tp where kode_unor=? union select tc.id,tc.kode_unor,tc.nama_jabatan,tc.level,tc.parent_id from tbl_unor tc join unor u on tc.parent_id=u.id) select u.id,u.kode_unor,u.nama_jabatan, level,parent_id,tb.nama,tb.nip,tb.pangkat, tb.path_foto, tb.gol,tb.id_jabatan,tb.id_satuan_kerja,(select array_to_json(array_agg(row_to_json(ds))) from( select tc.id,tc.kode_unor,tc.nama_unor,tc.nama_jabatan,tc.level,tc.parent_id,tp.nama,tp.nip nip,tp.pangkat, tp.path_foto, tp.gol,tp.id_jabatan,tp.id_satuan_kerja, (select array_to_json(array_agg(row_to_json(staff))) from( select tps.nip,nama,pangkat,gol,tps.id_jabatan,j.name jabatan,tps.path_foto,tsk.nama_satuan_kerja, tps.id_satuan_kerja from tbl_pegawai tps left join tbl_satuan_kerja tsk on tsk.id_satuan_kerja=tps.id_satuan_kerja left join jabatan j on j.id = cast (tps.id_jabatan as integer) where tps.id_satuan_kerja=tp.id_satuan_kerja and tps.nip<> tp.nip) staff)as children from tbl_unor tc left join tbl_pegawai tp on tp.kode_unor=tc.kode_unor where tc.parent_id=u.id)ds) as children from unor u left join tbl_pegawai tb on tb.kode_unor=u.kode_unor where level=cast(? as integer) order by kode_unor)t

get-staff-lev2= select array_to_json(array_agg(row_to_json(ds))) as data from( select tc.id,tc.kode_unor,tc.nama_unor,tc.nama_jabatan,tc.level,tc.parent_id,tp.nama, tp.nip1 nip,tp.pangkat, tp.path_foto, tp.gol,tp.id_jabatan,tp.id_satuan_kerja, (select array_to_json(array_agg(row_to_json(staff))) from (select tc.id id_unor,tc.parent_id parent_unor,tps.nip1 nip,nama,pangkat,gol,tps.id_jabatan,j.name jabatan,tps.path_foto,tsk.nama_satuan_kerja, tps.id_satuan_kerja from tbl_pegawai tps left join tbl_satuan_kerja tsk on tsk.id_satuan_kerja =tps.id_satuan_kerja left join jabatan j on j.id = cast (tps.id_jabatan as integer) where tps.id_satuan_kerja=tp.id_satuan_kerja and tps.nip1<> tp.nip1) staff)as children from tbl_unor tc left join tbl_pegawai tp on tp.kode_unor=tc.kode_unor where tc.parent_id=?)ds

get-staff-lev3=(select array_to_json(array_agg(row_to_json(ds))) as data from( select tc.id,tc.kode_unor,tc.nama_unor,tc.nama_jabatan,tc.level,tc.parent_id,tp.nama, tp.nip1 nip,tp.pangkat, tp.path_foto, tp.gol,tp.id_jabatan,tp.id_satuan_kerja, (select array_to_json(array_agg(row_to_json(staff))) from( select tc.id id_unor,tc.parent_id parent_unor,tps.nip1 nip,nama,pangkat,gol,tps.id_jabatan,j.name jabatan,tps.path_foto,tsk.nama_satuan_kerja, tps.id_satuan_kerja from tbl_pegawai tps left join tbl_satuan_kerja tsk on tsk.id_satuan_kerja =tps.id_satuan_kerja left join jabatan j on j.id = cast (tps.id_jabatan as integer) where tps.id_satuan_kerja=tp.id_satuan_kerja and tps.nip1<> tp.nip1) staff)as children from tbl_unor tc left join tbl_pegawai tp on tp.kode_unor=tc.kode_unor where tc.id=?)ds) 

get-dashboard = select 'surat masuk' category,count(1) total from surat_masuk sm where exists(select 1 from notifikasi where notif_nip=? and type='SURAT_MASUK' and id_content=sm.id) union select 'surat keluar' category,count(1) total from surat_keluar sk where exists(select 1 from notifikasi  where notif_nip=? and type='SURAT_KELUAR' and id_content=sk.id) union select 'disposisi' category,count(1) total from disposisi ds where exists(select 1 from notifikasi where notif_nip=? and type='DISPOSISI' and id_surat=ds.id)

get-flow-dispos= select ds.id,id_surat,id_tujuan,id_pengirim,no_agenda, ds.isi_disposisi,ds.is_view,ds.is_tindak_lanjut,ds.created_by,ds.created_at,ds.updated_at,ds.sifat_surat,ds.tindakan,ds.tgl_disposisi,ds.is_disposisi, tp.nama_unor unor_pengirim,tu.nama_unor unor_tujuan from disposisi ds left join tbl_unor tu on tu.id = cast(ds.id_tujuan as text) left join tbl_unor tp on tp.id = cast(ds.id_pengirim as text) where id_surat=cast(? as integer) order by ds.id

post-disposisi= insert into disposisi (id_surat,id_tujuan,id_pengirim,isi_disposisi,is_view,is_tindak_lanjut,created_at,updated_at,tgl_disposisi,is_disposisi,created_by,sifat_surat,tindakan) values(?,?,?,?,?,?,?,?,?,?,?,?,?)

post-notifikasi =insert into notifikasi (id_asal,id_tujuan,id_content,type,is_view,created_at,updated_at,notif_nip) values(?,?,?,?,?,?,?,?)

post-tindak-lanjut= insert into tindak_lanjut(id_disposisi,isi,created_by,created_at,updated_at) values(?,?,?,?,?)

update-inbox = update surat_masuk set id_asal=?, id_tujuan=?, is_disposisi=? where id=?

update-status-inbox = update surat_masuk set is_disposisi=? where id=? 

# new query

sql-get-user=select mail_id,mail_naskah,mail_perihal,mail_tgl_surat,mail_user,mail_no_agenda,mail_tgl_diterima, mail_alamat_pengirim,mail_cc,mail_klasifikasi, mail_jenis_surat, mail_sifat_surat,mail_jenis_instansi, mail_status,mano_type,mano_staff from mail,mail_notification where mail_id=mano_mail_id and mano_staff =? and mano_type=?


# // end::queries[]